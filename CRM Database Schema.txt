-- 线索表：存储线索的基本信息
CREATE TABLE leads (
    lead_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20),
    company_name VARCHAR(100),
    industry VARCHAR(50),
    source VARCHAR(50), -- 线索来源（如网站、展会、广告）
    lead_score INT DEFAULT 0, -- 线索评分（0-100）
    lead_status ENUM('new', 'warm', 'hot', 'closed', 'invalid') DEFAULT 'new', -- 线索状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 公司表：存储线索关联的公司信息，避免重复存储
CREATE TABLE companies (
    company_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_name VARCHAR(100) NOT NULL,
    industry VARCHAR(50),
    website VARCHAR(100),
    address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 线索与公司关联表（多对多关系）
CREATE TABLE lead_company (
    lead_id BIGINT,
    company_id BIGINT,
    PRIMARY KEY (lead_id, company_id),
    FOREIGN KEY (lead_id) REFERENCES leads(lead_id) ON DELETE CASCADE,
    FOREIGN KEY (company_id) REFERENCES companies(company_id) ON DELETE CASCADE
);

-- 交互记录表：存储与线索的每次交互（如邮件、电话、会议）
CREATE TABLE interactions (
    interaction_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    lead_id BIGINT,
    interaction_type ENUM('email', 'call', 'meeting', 'webinar', 'social_media') NOT NULL,
    interaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    description TEXT,
    outcome VARCHAR(100), -- 交互结果（如“已回复”、“无回应”）
    FOREIGN KEY (lead_id) REFERENCES leads(lead_id) ON DELETE CASCADE
);

-- 营销活动表：存储营销活动信息（如邮件营销、广告投放）
CREATE TABLE campaigns (
    campaign_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_name VARCHAR(100) NOT NULL,
    campaign_type ENUM('email', 'social_media', 'webinar', 'ads') NOT NULL,
    start_date DATE,
    end_date DATE,
    budget DECIMAL(10, 2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 线索与营销活动关联表：记录线索参与的营销活动
CREATE TABLE lead_campaign (
    lead_id BIGINT,
    campaign_id BIGINT,
    engagement_score INT DEFAULT 0, -- 参与度评分
    engaged_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (lead_id, campaign_id),
    FOREIGN KEY (lead_id) REFERENCES leads(lead_id) ON DELETE CASCADE,
    FOREIGN KEY (campaign_id) REFERENCES campaigns(campaign_id) ON DELETE CASCADE
);

-- 销售机会表：存储从线索转化的销售机会
CREATE TABLE opportunities (
    opportunity_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    lead_id BIGINT,
    opportunity_name VARCHAR(100) NOT NULL,
    amount DECIMAL(10, 2), -- 预计成交金额
    stage ENUM('prospect', 'negotiation', 'proposal', 'closed_won', 'closed_lost') NOT NULL,
    expected_close_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (lead_id) REFERENCES leads(lead_id) ON DELETE CASCADE
);

-- 用户表：存储销售和营销团队用户信息
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    role ENUM('sales', 'marketing', 'admin') NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 线索分配表：记录线索分配给哪个销售人员
CREATE TABLE lead_assignment (
    lead_id BIGINT,
    user_id BIGINT,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (lead_id, user_id),
    FOREIGN KEY (lead_id) REFERENCES leads(lead_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- 注释表：存储对线索的备注
CREATE TABLE notes (
    note_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    lead_id BIGINT,
    user_id BIGINT,
    note_content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (lead_id) REFERENCES leads(lead_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);